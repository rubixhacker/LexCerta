---
phase: 07-nextjs-migration
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "MCP clients can call parse_citation at the deployed /api/mcp/mcp endpoint and get correct results"
    - "MCP clients can call verify_west_citation at the deployed endpoint and get correct results"
    - "MCP clients can call verify_quote_integrity at the deployed endpoint and get correct results"
    - "Streamable HTTP transport works for MCP requests at /api/mcp/mcp"
  artifacts: []
  key_links:
    - from: "Vercel deployment"
      to: "app/api/mcp/[transport]/route.ts"
      via: "Next.js serverless function"
      pattern: "/api/mcp/mcp"
---

<objective>
Deploy the Next.js migration to Vercel and verify all three MCP tools work identically to v1.0 at the new endpoint URL.

Purpose: Phase 7 success criterion #2 requires MCP clients to get identical results at the new endpoint. This can only be verified after deployment with a real MCP client connection.

Output: Confirmed working deployment with MCP tools accessible at /api/mcp/mcp (Streamable HTTP) and /api/mcp/sse (SSE).
</objective>

<execution_context>
@/home/stewart/.claude/get-shit-done/workflows/execute-plan.md
@/home/stewart/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-nextjs-migration/07-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deploy to Vercel and verify endpoint responds</name>
  <files></files>
  <action>
1. Push changes to the repository (if not already pushed):
   ```bash
   git push origin master
   ```

2. Trigger Vercel deployment. Vercel should auto-detect Next.js framework and build with `next build`.

3. After deployment succeeds, verify the MCP endpoint is reachable by making a test request to the Streamable HTTP endpoint:
   ```bash
   curl -s -X POST https://lexcerta.vercel.app/api/mcp/mcp \
     -H "Content-Type: application/json" \
     -d '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2025-03-26","capabilities":{},"clientInfo":{"name":"test","version":"0.1.0"}}}'
   ```
   Expected: JSON-RPC response with server info (name: "lexcerta").

4. Verify the home page renders:
   ```bash
   curl -s https://lexcerta.vercel.app/ | head -20
   ```
   Expected: HTML containing "LexCerta" text.

5. If deployment fails, check Vercel build logs for errors. Common issues:
   - `"type": "module"` conflict: remove from package.json, commit, push
   - Missing environment variables: ensure `COURTLISTENER_API_KEY` is set in Vercel project settings
   - vercel.json routing issues: ensure no rewrites remain
  </action>
  <verify>
- Vercel deployment succeeds (build log shows `next build` completed)
- `curl -X POST /api/mcp/mcp` returns a JSON-RPC initialize response
- `curl /` returns HTML with "LexCerta" content
  </verify>
  <done>Next.js app deployed to Vercel. MCP endpoint responds at /api/mcp/mcp. Home page renders.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify MCP tools work via client</name>
  <files></files>
  <action>
Human verification step. What was built: Next.js migration deployed to Vercel with MCP endpoint at /api/mcp/mcp (Streamable HTTP) and /api/mcp/sse (SSE fallback). All three MCP tools should work identically to v1.0.

How to verify:
1. Update your MCP client configuration (e.g., Claude Desktop) to use the new endpoint URL:
   - Streamable HTTP: `https://lexcerta.vercel.app/api/mcp/mcp`
   - SSE (if needed): `https://lexcerta.vercel.app/api/mcp/sse`

2. Test `parse_citation` -- call with a known citation like "410 U.S. 113":
   - Expected: Returns parsed citation with volume=410, reporter="U.S.", page=113

3. Test `verify_west_citation` -- call with "410 U.S. 113":
   - Expected: Returns verification result (verified status, case name "Roe v. Wade")

4. Test `verify_quote_integrity` -- call with citation "410 U.S. 113" and a known quote from the opinion:
   - Expected: Returns quote verification score

5. Verify results are identical to what v1.0 produced (same response structure, same data).

Resume signal: Type "approved" if all three tools work correctly, or describe any issues encountered.
  </action>
  <verify>Human confirms all three MCP tools return correct results at new endpoint URL.</verify>
  <done>All three MCP tools (parse_citation, verify_west_citation, verify_quote_integrity) work identically to v1.0 at the new Next.js endpoint.</done>
</task>

</tasks>

<verification>
1. Vercel deployment succeeded with Next.js framework detection
2. MCP endpoint responds to JSON-RPC initialize request at /api/mcp/mcp
3. All three MCP tools (parse_citation, verify_west_citation, verify_quote_integrity) return correct results
4. SSE transport accessible at /api/mcp/sse
</verification>

<success_criteria>
- Deployed Next.js app on Vercel builds and serves correctly
- MCP Streamable HTTP transport works at /api/mcp/mcp
- All three tools return identical results to v1.0
- Human confirms tools work via MCP client
</success_criteria>

<output>
After completion, create `.planning/phases/07-nextjs-migration/07-02-SUMMARY.md`
</output>
