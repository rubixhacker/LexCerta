---
phase: 06-production-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/server.ts
  - api/server.ts
  - vercel.json
  - package.json
autonomous: true
user_setup:
  - service: vercel
    why: "Deployment hosting and environment variable configuration"
    env_vars:
      - name: COURTLISTENER_API_KEY
        source: "Vercel Dashboard -> Project Settings -> Environment Variables"
    dashboard_config:
      - task: "Connect GitHub repo to Vercel project (or deploy via vercel CLI)"
        location: "Vercel Dashboard -> New Project -> Import Git Repository"

must_haves:
  truths:
    - "api/server.ts exports GET, POST, DELETE handlers that register all LexCerta tools via mcp-handler"
    - "vercel.json rewrites all paths to api/server and sets maxDuration 60"
    - "src/server.ts exports registerTools() and createServer() still works for local dev"
    - "All existing tests pass unchanged"
  artifacts:
    - path: "api/server.ts"
      provides: "Vercel Functions entry point using mcp-handler"
      exports: ["GET", "POST", "DELETE"]
    - path: "vercel.json"
      provides: "Vercel routing and function configuration"
      contains: "rewrites"
    - path: "src/server.ts"
      provides: "Shared tool registration via registerTools() + local dev createServer()"
      exports: ["registerTools", "createServer", "resetClient"]
  key_links:
    - from: "api/server.ts"
      to: "src/server.ts"
      via: "import { registerTools }"
      pattern: "registerTools\\(server"
    - from: "api/server.ts"
      to: "src/config.ts"
      via: "import { loadConfig }"
      pattern: "loadConfig\\(\\)"
    - from: "vercel.json"
      to: "api/server.ts"
      via: "rewrites destination"
      pattern: "/api/server"
---

<objective>
Deploy LexCerta to Vercel via mcp-handler so remote MCP clients can connect over the internet.

Purpose: This is the final phase -- making LexCerta accessible to remote AI agents. The server already works locally; this plan adds the Vercel entry point alongside the existing local dev path.

Output: `api/server.ts` (Vercel handler), `vercel.json` (routing), refactored `src/server.ts` with exported `registerTools()`.
</objective>

<execution_context>
@/home/stewart/.claude/get-shit-done/workflows/execute-plan.md
@/home/stewart/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-production-deployment/06-RESEARCH.md
@src/server.ts
@src/config.ts
@src/index.ts
@tsconfig.json
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract registerTools() and create Vercel entry point</name>
  <files>src/server.ts, api/server.ts, vercel.json, package.json</files>
  <action>
1. Install mcp-handler: `npm install mcp-handler@^1.0.7`

2. Refactor `src/server.ts` -- extract a `registerTools(server, config)` function:
   - Move tool registration logic (lines that call getClient, getCache, getOpinionCache, and all registerXxxTool calls) into a new exported function `registerTools(server: McpServer, config: Config): void`
   - Update `createServer()` to call `registerTools(server, config)` internally
   - Keep all singleton getters (getClient, getCache, getOpinionCache) and resetClient() unchanged
   - Export both `registerTools` and `createServer`
   - `src/index.ts` continues to use `createServer()` unchanged -- do NOT modify index.ts

3. Create `api/server.ts` (Vercel Functions entry point):
   ```typescript
   import { createMcpHandler } from "mcp-handler";
   import { loadConfig } from "../src/config.js";
   import { registerTools } from "../src/server.js";

   const config = loadConfig();

   const handler = createMcpHandler(
     (server) => {
       registerTools(server, config);
     },
     {
       serverInfo: { name: "lexcerta", version: "0.1.0" },
       capabilities: { logging: {} },
     },
     {
       basePath: "/api",
       maxDuration: 60,
     }
   );

   export { handler as GET, handler as POST, handler as DELETE };
   ```
   Note: Do NOT use Edge Runtime. Node.js runtime (the default) is required for cockatiel, lru-cache, fuzzball compatibility.

4. Create `vercel.json` at project root:
   ```json
   {
     "rewrites": [{ "source": "/(.+)", "destination": "/api/server" }],
     "functions": {
       "api/server.ts": {
         "maxDuration": 60
       }
     }
   }
   ```

5. Verify `api/server.ts` is NOT included in the existing tsconfig.json (it shouldn't be -- tsconfig has `rootDir: ./src` and `include: ["src/**/*"]`). Vercel compiles `api/` files with its own pipeline, so this is correct. Do NOT modify tsconfig.json.
  </action>
  <verify>
- `npm test` passes (all existing tests unchanged)
- `npx tsc --noEmit` passes (src/ still compiles cleanly)
- `api/server.ts` exists and exports GET, POST, DELETE
- `vercel.json` exists with rewrites and functions config
- `src/server.ts` exports both `registerTools` and `createServer`
- `grep -q "registerTools" src/server.ts` confirms the function exists
- `src/index.ts` is unchanged (still uses createServer)
  </verify>
  <done>
- `registerTools()` is exported from `src/server.ts` and used by both `createServer()` and `api/server.ts`
- `api/server.ts` creates an mcp-handler with all LexCerta tools registered
- `vercel.json` routes all requests to api/server with 60s maxDuration
- `mcp-handler` is in package.json dependencies
- All existing tests pass without modification
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify deployment readiness</name>
  <files>api/server.ts, vercel.json, src/server.ts, package.json</files>
  <action>
1. Run the full test suite: `npm test -- --run`
   - All existing tests must pass. The refactoring of createServer() to use registerTools() internally should be a transparent change.
   - If any test fails, debug and fix the registerTools() extraction (likely an import or singleton issue).

2. Run the linter: `npx biome check src/`
   - Fix any linting issues introduced by the refactor.

3. Verify the deployment files are correct:
   - `api/server.ts` imports resolve correctly (relative paths to ../src/)
   - `vercel.json` is valid JSON
   - `package.json` has `mcp-handler` in dependencies
   - `src/server.ts` exports registerTools (grep for `export function registerTools`)

4. Verify local dev still works by checking `src/index.ts` is untouched and still imports createServer from ./server.js.
  </action>
  <verify>
- `npm test -- --run` exits 0 with all tests passing
- `npx biome check src/` exits 0
- `node -e "JSON.parse(require('fs').readFileSync('vercel.json','utf8'))"` exits 0 (valid JSON)
- `grep "mcp-handler" package.json` shows the dependency
  </verify>
  <done>
- All existing tests pass
- Linter passes
- vercel.json is valid
- mcp-handler dependency is installed
- Local dev path (src/index.ts -> createServer) is unchanged
  </done>
</task>

</tasks>

<verification>
1. `npm test -- --run` -- all existing tests pass (no behavioral changes)
2. `npx tsc --noEmit` -- TypeScript compilation succeeds for src/
3. `api/server.ts` exports GET, POST, DELETE via mcp-handler
4. `vercel.json` rewrites to /api/server with maxDuration: 60
5. `src/server.ts` exports registerTools() used by both entry points
6. `grep "mcp-handler" package.json` confirms dependency installed
</verification>

<success_criteria>
- registerTools() extracted and shared between local dev and Vercel entry points
- api/server.ts + vercel.json ready for `vercel deploy` or git-push deployment
- All existing tests pass unchanged
- No modifications to src/index.ts, src/config.ts, or any tool/client code
</success_criteria>

<output>
After completion, create `.planning/phases/06-production-deployment/06-01-SUMMARY.md`
</output>
